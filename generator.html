<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Question Paper Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Updated vibrant color palette */
            --bg-color-start: #f0f9ff; /* sky-50 */
            --bg-color-end: #eef2ff;   /* indigo-50 */
            --card-bg-color: #ffffff;
            --text-color: #1e293b;     /* slate-800 */
            --muted-text-color: #475569; /* slate-600 */
            --border-color: #e2e8f0;   /* slate-200 */
            --primary-color: #4f46e5;  /* indigo-600 */
            --primary-hover-color: #4338ca; /* indigo-700 */
            --primary-focus-ring: #a5b4fc; /* indigo-200 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-start);
            /* Added a subtle, vibrant gradient background */
            background-image: linear-gradient(to bottom right, var(--bg-color-start), var(--bg-color-end));
            color: var(--text-color);
        }

        /* Custom styles for Bengali font in the question paper */
        .question-paper, .question-paper li {
            font-family: 'Hind Siliguri', sans-serif;
        }

        /* Styling for form elements to match the new theme */
        .form-input {
            border-color: var(--border-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            --tw-ring-color: var(--primary-focus-ring);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-focus-ring);
        }
        .form-checkbox {
            color: var(--primary-color);
        }
        .form-checkbox:focus {
            --tw-ring-color: var(--primary-focus-ring);
        }

        /* Print styles to ensure the paper looks good on paper */
        @media print {
            body {
                background: none;
            }
            #controls-card, #printBtn, #generateBtn {
                display: none;
            }
            #paper-output {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
            }
            .question-paper-container {
                color: #000;
            }
        }
        /* Added subtle animations for a smoother feel */
        .card-enter {
            animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-8">

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Controls Card -->
        <div id="controls-card" class="lg:col-span-1 bg-[var(--card-bg-color)] p-6 rounded-2xl shadow-lg border border-[var(--border-color)] h-fit card-enter">
            <!-- Header -->
            <div class="border-b border-[var(--border-color)] pb-4 mb-6">
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-500">Paper Generator</h1>
                <p class="text-[var(--muted-text-color)] mt-1">Customize your math question paper.</p>
            </div>
            
            <div class="space-y-6">
                <!-- Class Selection -->
                <div>
                    <label for="classSelect" class="block text-sm font-medium text-[var(--muted-text-color)] mb-1">Class</label>
                    <select id="classSelect" class="w-full rounded-lg form-input">
                        <option value="11">Class 11</option>
                        <option value="12">Class 12</option>
                    </select>
                </div>

                <!-- Total Marks -->
                <div>
                    <label for="totalMarks" class="block text-sm font-medium text-[var(--muted-text-color)] mb-1">Total Marks</label>
                    <input type="number" id="totalMarks" value="50" class="w-full rounded-lg form-input">
                </div>

                <!-- Section Configuration -->
                <div>
                    <h3 class="text-lg font-semibold text-[var(--text-color)] mb-2">Sections</h3>
                    <div id="sectionsContainer" class="space-y-4">
                        <!-- Sections will be dynamically added here -->
                    </div>
                    <button id="addSectionBtn" class="mt-4 w-full text-sm font-semibold py-2 px-4 rounded-lg border-2 border-dashed border-slate-300 text-slate-500 hover:bg-slate-100 hover:border-slate-400 transition">
                        + Add Section
                    </button>
                </div>
            </div>
        </div>

        <!-- Paper Output -->
        <div id="paper-output" class="lg:col-span-2 bg-[var(--card-bg-color)] p-6 sm:p-8 rounded-2xl shadow-lg border border-[var(--border-color)] card-enter" style="animation-delay: 0.1s;">
            <div id="placeholder">
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-[var(--text-color)]">Your paper will appear here</h3>
                    <p class="mt-1 text-sm text-[var(--muted-text-color)]">Fill in the details on the left and click generate.</p>
                </div>
            </div>
            <div id="paperContent" class="hidden prose max-w-none">
                <!-- Generated paper content will be injected here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="lg:col-span-3 flex justify-center items-center gap-4 mt-2 card-enter" style="animation-delay: 0.2s;">
            <button id="generateBtn" class="px-8 py-3 font-bold text-white bg-[var(--primary-color)] rounded-xl shadow-lg hover:bg-[var(--primary-hover-color)] transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[var(--primary-focus-ring)]">
                Generate Paper
            </button>
            <button id="printBtn" class="hidden px-8 py-3 font-bold text-[var(--primary-color)] bg-white rounded-xl shadow-lg border border-[var(--border-color)] hover:bg-indigo-50 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[var(--primary-focus-ring)]">
                Print
            </button>
        </div>
    </main>

    <script>
        // --- DOM Elements ---
        const classSelect = document.getElementById('classSelect');
        const totalMarksInput = document.getElementById('totalMarks');
        const sectionsContainer = document.getElementById('sectionsContainer');
        const addSectionBtn = document.getElementById('addSectionBtn');
        const generateBtn = document.getElementById('generateBtn');
        const printBtn = document.getElementById('printBtn');
        const placeholder = document.getElementById('placeholder');
        const paperContent = document.getElementById('paperContent');

        let allQuestions = [];
        let chaptersByClass = { 11: [], 12: [] };
        let sectionCount = 0;

        // --- Data Loading ---
        async function loadQuestions() {
            try {
                const response = await fetch('./Math_Database.csv');
                const csvText = await response.text();
                // Using a simple split-based parser
                const rows = csvText.split('\n').slice(1);
                allQuestions = rows.map(row => {
                    // This simple regex handles commas inside quoted fields
                    const values = row.match(/(\\.|"([^"]*)"|[^",]+),/g).map(val => val.slice(0,-1).replace(/^"|"$/g, ''));
                    if (values.length === 8) {
                        return {
                            id: values[0],
                            question_text: values[1],
                            chapter: values[2],
                            class_level: parseInt(values[3], 10),
                            semester: parseInt(values[4], 10),
                            difficulty: values[5],
                            marks: parseInt(values[6], 10),
                            answer: values[7]
                        };
                    }
                    return null;
                }).filter(Boolean); // Filter out any null rows

                // Populate chapter lists
                allQuestions.forEach(q => {
                    if (q.class_level === 11 && !chaptersByClass[11].includes(q.chapter)) {
                        chaptersByClass[11].push(q.chapter);
                    } else if (q.class_level === 12 && !chaptersByClass[12].includes(q.chapter)) {
                        chaptersByClass[12].push(q.chapter);
                    }
                });
                updateChapterList(); // Initial call
                addSection(); // Add one section by default
            } catch (error) {
                console.error("Error loading or parsing CSV:", error);
                paperContent.innerHTML = `<div class="text-red-600">Failed to load question database. Please check the console for errors.</div>`;
                paperContent.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
        }

        // --- UI Updates ---
        function updateChapterList() {
            document.querySelectorAll('.chapter-select').forEach(select => {
                const currentClass = classSelect.value;
                const selectedValue = select.value;
                select.innerHTML = `<option value="any">Any Chapter</option>`;
                chaptersByClass[currentClass].forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter;
                    option.textContent = chapter;
                    select.appendChild(option);
                });
                // Try to preserve selection if the chapter exists in the new list
                if (chaptersByClass[currentClass].includes(selectedValue)) {
                    select.value = selectedValue;
                }
            });
        }
        
        function addSection() {
            sectionCount++;
            const sectionId = `section-${sectionCount}`;
            const sectionDiv = document.createElement('div');
            sectionDiv.id = sectionId;
            sectionDiv.className = 'p-4 border border-[var(--border-color)] rounded-lg space-y-3 relative';

            const chapters = chaptersByClass[classSelect.value];
            const chapterOptions = chapters.map(c => `<option value="${c}">${c}</option>`).join('');

            sectionDiv.innerHTML = `
                <button type="button" class="absolute -top-2 -right-2 bg-red-100 text-red-600 rounded-full h-6 w-6 flex items-center justify-center font-bold hover:bg-red-200" onclick="removeSection('${sectionId}')">&times;</button>
                <input type="text" placeholder="Section Title (e.g., Group A)" class="w-full text-sm rounded-md form-input section-title" value="Group ${String.fromCharCode(64 + sectionCount)}">
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <input type="number" placeholder="Num Qs" class="w-full rounded-md form-input section-num-qs">
                    <select class="w-full rounded-md form-input section-marks">
                        <option value="any">Any Marks</option>
                        <option value="1">1 Mark</option>
                        <option value="2">2 Marks</option>
                        <option value="4">4 Marks</option>
                        <option value="5">5 Marks</option>
                    </select>
                </div>
                <select class="w-full text-sm rounded-md form-input chapter-select">
                    <option value="any">Any Chapter</option>
                    ${chapterOptions}
                </select>
                <select class="w-full text-sm rounded-md form-input section-difficulty">
                    <option value="any">Any Difficulty</option>
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
            `;
            sectionsContainer.appendChild(sectionDiv);
        }

        function removeSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.remove();
            }
        }

        // --- Paper Generation Logic ---
        function generatePaper() {
            const selectedClass = parseInt(classSelect.value, 10);
            const totalMarks = parseInt(totalMarksInput.value, 10);
            const sections = [];
            let warnings = [];

            document.querySelectorAll('#sectionsContainer > div').forEach(div => {
                sections.push({
                    title: div.querySelector('.section-title').value || 'Section',
                    num: parseInt(div.querySelector('.section-num-qs').value, 10),
                    marks: div.querySelector('.section-marks').value,
                    chapter: div.querySelector('.chapter-select').value,
                    difficulty: div.querySelector('.section-difficulty').value
                });
            });

            let availableQuestions = allQuestions.filter(q => q.class_level === selectedClass);
            let paperHTML = `<div class="text-center mb-8"><h2 class="text-2xl font-bold" style="font-family: 'Inter', sans-serif;">Generated Question Paper</h2><p class="text-sm text-gray-500" style="font-family: 'Inter', sans-serif;">Class: ${selectedClass} | Total Marks: ${totalMarks}</p></div>`;

            sections.forEach(section => {
                if (isNaN(section.num) || section.num <= 0) {
                    warnings.push(`Invalid number of questions for section "${section.title}". Skipping.`);
                } else {
                    let filteredQs = [...availableQuestions];
                    if (section.marks !== 'any') filteredQs = filteredQs.filter(q => q.marks === parseInt(section.marks, 10));
                    if (section.chapter !== 'any') filteredQs = filteredQs.filter(q => q.chapter === section.chapter);
                    if (section.difficulty !== 'any') filteredQs = filteredQs.filter(q => q.difficulty === section.difficulty);

                    if (filteredQs.length < section.num) {
                        warnings.push(`Not enough questions for section "${section.title}" (found ${filteredQs.length}, needed ${section.num}). Using all available.`);
                    }
                    
                    // Fisher-Yates shuffle
                    for (let i = filteredQs.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [filteredQs[i], filteredQs[j]] = [filteredQs[j], filteredQs[i]];
                    }

                    const selectedQs = filteredQs.slice(0, section.num);
                    
                    if (selectedQs.length > 0) {
                         // Remove used questions from the available pool to prevent duplicates
                         availableQuestions = availableQuestions.filter(q => !selectedQs.some(sq => sq.id === q.id));

                         paperHTML += `<div class="mb-6 question-paper-container"><h4 class="text-lg font-bold underline" style="font-family: 'Inter', sans-serif;">${section.title}</h4><p class="mb-2 ml-4" style="font-family: 'Inter', sans-serif;">Answer any ${section.num} questions:</p><ol class="list-decimal list-inside ml-4 question-paper">`;
                         selectedQs.forEach(q => { paperHTML += `<li class="mb-2">${q.question_text}</li>`; });
                         paperHTML += `</ol></div>`;
                    }
                }
            });
            
            if (warnings.length > 0) {
                paperHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 rounded-md" role="alert"><p class="font-bold">Warnings</p><ul class="list-disc list-inside ml-4 mt-1">${warnings.map(w => `<li>${w}</li>`).join('')}</ul></div>` + paperHTML;
            }

            placeholder.classList.add('hidden');
            paperContent.innerHTML = paperHTML;
            paperContent.classList.remove('hidden');
            printBtn.classList.remove('hidden');
        }

        function printPaper() { window.print(); }

        // --- Event Listeners and Initial Load ---
        generateBtn.addEventListener('click', generatePaper);
        printBtn.addEventListener('click', printPaper);
        addSectionBtn.addEventListener('click', addSection);
        classSelect.addEventListener('change', updateChapterList);
        
        document.addEventListener('DOMContentLoaded', loadQuestions);
    </script>
</body>
</html>

